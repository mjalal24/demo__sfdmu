name: Custom SF CLI Delta Generation Workflow

on:
  push:
    branches:
      - main

jobs:
  generate-delta:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository with full Git history.
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures the complete Git history is available.

      # Step 2: Fetch all remote branches so that they are available.
      - name: Fetch Remote Branches
        run: git fetch --all

      # Step 3: Cache the custom Docker image as a tar file.
      - name: Cache Custom Docker Image
        id: cache-docker
        uses: actions/cache@v3
        with:
          path: custom-sf.tar
          key: custom-sf-image

      # Step 4: Load the cached image if available; otherwise, build it.
      - name: Load or Build Custom Docker Image
        run: |
          if [ -f custom-sf.tar ]; then
            echo "Cached Docker image found. Loading image..."
            docker load -i custom-sf.tar
          else
            echo "No cached image found. Building custom Docker image..."
            docker build -t custom-sf:latest .
            docker save custom-sf:latest -o custom-sf.tar
          fi

      # Step 5: Generate the delta manifest using commit SHA pointers.
      # This step runs the 'sf sgd:source:delta' command inside the custom-sf container.
      - name: Generate Delta Manifest
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            custom-sf:latest \
            sf sgd:source:delta --to "HEAD" --from "HEAD^" --output /workspace
