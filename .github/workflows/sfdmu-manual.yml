name: Custom SF CLI Delta Generation Workflow

on:
  push:
    branches:
      - main

jobs:
  generate-delta:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository with full Git history.
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures the complete Git history is available.

      # Step 2: Fetch all remote branches so that they are available.
      - name: Fetch Remote Branches
        run: git fetch --all

      # (Optional) Verify the current commit and its parent.
      - name: Verify Git References
        run: |
          echo "Current commit (HEAD):"
          git rev-parse HEAD
          echo "Previous commit (HEAD^):"
          git rev-parse HEAD^ 2>/dev/null || echo "No previous commit available."

      # Step 3: Cache the custom Docker image as a tar file.
      - name: Cache Custom Docker Image
        id: cache-docker
        uses: actions/cache@v3
        with:
          path: custom-sf.tar
          key: custom-sf-image

      # Step 4: Load the cached image if available; otherwise, build it.
      - name: Load or Build Custom Docker Image
        run: |
          if [ -f custom-sf.tar ]; then
            echo "Cached Docker image found. Loading image..."
            docker load -i custom-sf.tar
          else
            echo "No cached image found. Building custom Docker image..."
            docker build -t custom-sf:latest .
            docker save custom-sf:latest -o custom-sf.tar
          fi

      # Step 5: Generate the delta manifest using commit SHA pointers.
      - name: Generate Delta Manifest
        run: |
          # Ensure the output directories exist.
          mkdir -p package destructiveChanges

          # Get the commit SHAs.
          FROM_SHA=$(git rev-parse HEAD^ 2>/dev/null || echo "")
          TO_SHA=$(git rev-parse HEAD)

          # If there is no previous commit (e.g., on the first commit), use the same commit for both.
          if [ -z "$FROM_SHA" ]; then
            echo "No previous commit found. Using the current commit for both from and to."
            FROM_SHA=$TO_SHA
          fi

          echo "Generating delta from commit $FROM_SHA to $TO_SHA"

          # Run the container and pass the resolved commit SHAs.
          docker run --rm \
            -v "$PWD":/workspace \
            -w /workspace \
            custom-sf:latest \
            sh -c "sf sgd source delta --from ${FROM_SHA} --to ${TO_SHA} --output-dir ."

          # Display the generated artifacts.
          echo "Generated package/package.xml:"
          cat package/package.xml || echo "package.xml not found."
          echo ""
          echo "Generated destructiveChanges/destructiveChanges.xml:"
          cat destructiveChanges/destructiveChanges.xml || echo "destructiveChanges.xml not found."
